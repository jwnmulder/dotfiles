#!/bin/bash

# TODO: only change if SSH is available
SSH_REPO_URL="git@github.com:jwnmulder/dotfiles.git"

yadm_bin=~/.local/bin/yadm
[ ! -f $yadm_bin ] && yadm_bin=yadm

# Because Git submodule commands cannot operate without a work tree, they must
# be run from within $HOME (assuming this is the root of your dotfiles)
cd "$HOME"

echo "Init/update submodules"
yadm submodule update --recursive --init --remote

#-----------------------------------------
# * Configure git sparseCheckout to exclude some files from being checked out (e.g. README.md)
#-----------------------------------------

$yadm_bin gitconfig core.sparseCheckout true

cat << EOF > "$HOME/.local/share/yadm/repo.git/info/sparse-checkout"
# generated by $0
/*
!README.md
EOF

# yadm reset as otherwise 'yadm status' will show a lot of deleted files
$yadm_bin reset > /dev/null

# yadm checkout to activate the sparseCheckout config above
$yadm_bin checkout --quiet

#-----------------------------------------
# * Set yadm origin url to ssh (when our environment is WSL)
#-----------------------------------------

# If running inside WSL
if [[ -n "$IS_WSL" || -n "$WSL_DISTRO_NAME" ]]; then
#if [[ -n "$SSH_AUTH_SOCK" ]]; then

  current_repo=$(yadm enter git remote get-url origin)
  if [ "$current_repo" != "$SSH_REPO_URL" ]; then
    echo "Updating the yadm repo origin URL to $SSH_REPO_URL"
    yadm remote set-url origin "$SSH_REPO_URL"
  fi

fi

echo "Done!"
